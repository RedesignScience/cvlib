<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cvpack.path_in_rmsd_space &#8212; CVPack v0.12.1  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=572d9513" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=ccdb6887"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cvpack.path_in_rmsd_space</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. class:: PathInRMSDSpace</span>
<span class="sd">   :platform: Linux, MacOS, Windows</span>
<span class="sd">   :synopsis: A metric of progress or deviation with respect to a path in RMSD space</span>

<span class="sd">.. classauthor:: Charlles Abreu &lt;craabreu@gmail.com&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>

<span class="kn">from</span> <span class="nn">openmm</span> <span class="kn">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">mmunit</span>

<span class="kn">from</span> <span class="nn">.base_path_cv</span> <span class="kn">import</span> <span class="n">BasePathCV</span>
<span class="kn">from</span> <span class="nn">.path</span> <span class="kn">import</span> <span class="n">Metric</span><span class="p">,</span> <span class="n">progress</span>
<span class="kn">from</span> <span class="nn">.rmsd</span> <span class="kn">import</span> <span class="n">RMSD</span>
<span class="kn">from</span> <span class="nn">.units.units</span> <span class="kn">import</span> <span class="n">VectorQuantity</span>


<div class="viewcode-block" id="PathInRMSDSpace">
<a class="viewcode-back" href="../../api/PathInRMSDSpace.html#cvpack.PathInRMSDSpace">[docs]</a>
<span class="k">class</span> <span class="nc">PathInRMSDSpace</span><span class="p">(</span><span class="n">BasePathCV</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A metric of the system&#39;s progress (:math:`s`) or deviation (:math:`z`) with</span>
<span class="sd">    respect to a path defined by a sequence of :math:`n` milestones defined as</span>
<span class="sd">    reference structures :cite:`Branduardi_2007`:</span>

<span class="sd">    .. math::</span>

<span class="sd">        s({\bf r}) = \frac{</span>
<span class="sd">            \dfrac{\sum_{i=1}^n i w_i({\bf r})}{\sum_{i=1}^n w_i({\bf r})} - 1</span>
<span class="sd">        }{n-1}</span>
<span class="sd">        \quad \text{or} \quad</span>
<span class="sd">        z({\bf r}) = - 2 \sigma ^2 \ln \sum_{i=1}^n w_i({\bf r})</span>

<span class="sd">    with :math:`w_i({\bf r})` being a Gaussian kernel centered at the :math:`i`-th</span>
<span class="sd">    milestone, i.e.,</span>

<span class="sd">    .. math::</span>

<span class="sd">        w_i({\bf r}) = \exp\left(\</span>
<span class="sd">            -\frac{d^2_{\rm rms}({\bf r},{\bf r}^{\rm ref}_i)}{2 \sigma^2}</span>
<span class="sd">        \right)</span>

<span class="sd">    where :math:`d_{\rm rms}({\bf r},{\bf r}^{\rm ref}_i)` is the root-mean-square</span>
<span class="sd">    distance between the current system state and the :math:`i`-th reference structure</span>
<span class="sd">    and :math:`\sigma` sets the width of the kernels.</span>

<span class="sd">    .. note::</span>

<span class="sd">        The kernel width :math:`\sigma` is related to the parameter :math:`\lambda` of</span>
<span class="sd">        Ref. :cite:`Branduardi_2007` by :math:`\sigma = \frac{1}{\sqrt{2\lambda}}`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    metric</span>
<span class="sd">        The path-related metric to compute. Use ``cvpack.path.progress`` for</span>
<span class="sd">        computing :math:`s({\bf r})` or ``cvpack.path.deviation`` for computing</span>
<span class="sd">        :math:`z({\bf r})`.</span>
<span class="sd">    milestones</span>
<span class="sd">        A sequence of reference structures, each represented as a dictionary mapping</span>
<span class="sd">        atom indices to coordinate vectors.</span>
<span class="sd">    numAtoms</span>
<span class="sd">        The total number of atoms in the system, including those that are not in</span>
<span class="sd">        any of the reference structures.</span>
<span class="sd">    sigma</span>
<span class="sd">        The width of the Gaussian kernels in nanometers</span>
<span class="sd">    name</span>
<span class="sd">        The name of the collective variable. If not provided, it is set to</span>
<span class="sd">        &quot;path_progress_in_rmsd_space&quot; or &quot;path_deviation_in_rmsd_space&quot; depending</span>
<span class="sd">        on the metric.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        The number of milestones is less than 2</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the metric is not `cvpack.path.progress` or `cvpack.path.deviation`</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import cvpack</span>
<span class="sd">    &gt;&gt;&gt; import networkx as nx</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; import openmm</span>
<span class="sd">    &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">    &gt;&gt;&gt; from openmmtools import testsystems</span>
<span class="sd">    &gt;&gt;&gt; from scipy.spatial.transform import Rotation</span>
<span class="sd">    &gt;&gt;&gt; model = testsystems.AlanineDipeptideVacuum()</span>
<span class="sd">    &gt;&gt;&gt; atom1, atom2 = 8, 14</span>
<span class="sd">    &gt;&gt;&gt; graph = model.mdtraj_topology.to_bondgraph()</span>
<span class="sd">    &gt;&gt;&gt; nodes = list(graph.nodes)</span>
<span class="sd">    &gt;&gt;&gt; graph.remove_edge(nodes[atom1], nodes[atom2])</span>
<span class="sd">    &gt;&gt;&gt; movable = list(nx.connected_components(graph))[1]</span>
<span class="sd">    &gt;&gt;&gt; x = model.positions / model.positions.unit</span>
<span class="sd">    &gt;&gt;&gt; x0 = x[atom1, :]</span>
<span class="sd">    &gt;&gt;&gt; vector = x[atom2, :] - x0</span>
<span class="sd">    &gt;&gt;&gt; vector /= np.linalg.norm(vector)</span>
<span class="sd">    &gt;&gt;&gt; rotation = Rotation.from_rotvec((np.pi / 6) * vector)</span>
<span class="sd">    &gt;&gt;&gt; atoms = [nodes.index(atom) for atom in movable]</span>
<span class="sd">    &gt;&gt;&gt; frames = [x.copy()]</span>
<span class="sd">    &gt;&gt;&gt; for _ in range(6):</span>
<span class="sd">    ...     x[atoms, :] = x0 + rotation.apply(x[atoms, :] - x0)</span>
<span class="sd">    ...     frames.append(x.copy())</span>
<span class="sd">    &gt;&gt;&gt; milestones = [</span>
<span class="sd">    ...     {i: row for i, row in enumerate(frame)}</span>
<span class="sd">    ...     for frame in frames</span>
<span class="sd">    ... ]</span>
<span class="sd">    &gt;&gt;&gt; s, z = [</span>
<span class="sd">    ...    cvpack.PathInRMSDSpace(</span>
<span class="sd">    ...        metric, milestones, len(x), 0.5 * unit.angstrom</span>
<span class="sd">    ...    )</span>
<span class="sd">    ...    for metric in (cvpack.path.progress, cvpack.path.deviation)</span>
<span class="sd">    ... ]</span>
<span class="sd">    &gt;&gt;&gt; s.addToSystem(model.system)</span>
<span class="sd">    &gt;&gt;&gt; z.addToSystem(model.system)</span>
<span class="sd">    &gt;&gt;&gt; context = openmm.Context(model.system, openmm.VerletIntegrator(0.001))</span>
<span class="sd">    &gt;&gt;&gt; context.setPositions(model.positions)</span>
<span class="sd">    &gt;&gt;&gt; s.getValue(context)</span>
<span class="sd">    0.172... dimensionless</span>
<span class="sd">    &gt;&gt;&gt; z.getValue(context)</span>
<span class="sd">    -0.004... nm**2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-branches</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="n">Metric</span><span class="p">,</span>
        <span class="n">milestones</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">VectorQuantity</span><span class="p">]],</span>
        <span class="n">numAtoms</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">:</span> <span class="n">mmunit</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generateName</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;rmsd&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mmunit</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">sigma</span><span class="p">):</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">mmunit</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">milestones</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least two reference structures are required.&quot;</span><span class="p">)</span>
        <span class="n">collective_variables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;rmsd</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">RMSD</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">reference</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">numAtoms</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;rmsd</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">reference</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">milestones</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">squared_distances</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;rmsd</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">^2&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">squared_distances</span><span class="p">,</span> <span class="n">collective_variables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registerCV</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">mmunit</span><span class="o">.</span><span class="n">dimensionless</span> <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="n">progress</span> <span class="k">else</span> <span class="n">mmunit</span><span class="o">.</span><span class="n">nanometers</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">milestones</span><span class="o">=</span><span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">milestones</span><span class="p">],</span>
            <span class="n">numAtoms</span><span class="o">=</span><span class="n">numAtoms</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
        <span class="p">)</span></div>



<span class="n">PathInRMSDSpace</span><span class="o">.</span><span class="n">registerTag</span><span class="p">(</span><span class="s2">&quot;!cvpack.PathInRMSDSpace&quot;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CVPack v0.12.1</a></h1>











<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Collective Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reporting.html">Reporting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serialization.html">Serialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">Bibliography</a></li>
</ul>

<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024 C. Abreu & Redesign Science.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>
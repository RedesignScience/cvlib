<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cvpack.attraction_strength &#8212; CVPack  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=572d9513" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=ccdb6887"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cvpack.attraction_strength</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. class:: AttractionStrength</span>
<span class="sd">   :platform: Linux, MacOS, Windows</span>
<span class="sd">   :synopsis: The strength of the attraction between two atom groups</span>

<span class="sd">.. classauthor:: Charlles Abreu &lt;craabreu@gmail.com&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>

<span class="kn">import</span> <span class="nn">openmm</span>
<span class="kn">import</span> <span class="nn">xmltodict</span>

<span class="kn">from</span> <span class="nn">cvpack</span> <span class="kn">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">mmunit</span>

<span class="kn">from</span> <span class="nn">.cvpack</span> <span class="kn">import</span> <span class="n">AbstractCollectiveVariable</span>

<span class="n">ONE_4PI_EPS0</span> <span class="o">=</span> <span class="mf">138.93545764438198</span>


<span class="k">class</span> <span class="nc">_NonbondedForce</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">xmltodict</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">XmlSerializer</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">XmlSerializer</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">xmltodict</span><span class="o">.</span><span class="n">unparse</span><span class="p">(</span><span class="n">state</span><span class="p">)))</span>


<div class="viewcode-block" id="AttractionStrength">
<a class="viewcode-back" href="../../api/AttractionStrength.html#cvpack.AttractionStrength">[docs]</a>
<span class="k">class</span> <span class="nc">AttractionStrength</span><span class="p">(</span><span class="n">openmm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">,</span> <span class="n">AbstractCollectiveVariable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The strength of the attraction between two atom groups:</span>

<span class="sd">    .. math::</span>

<span class="sd">        S_{\\rm attr}({\\bf r}) =</span>
<span class="sd">            &amp;-\\sum_{i \\in {\\bf g}_1}</span>
<span class="sd">                \\sum_{\\substack{j \\in {\\bf g}_2 \\\\ j \\neq i}}</span>
<span class="sd">                    \\epsilon_{ij} u_{\\rm disp}\\left(</span>
<span class="sd">                        \\frac{\\|{\\bf r}_i - {\\bf r}_j\\|}{\\sigma_{ij}}</span>
<span class="sd">                    \\right) \\\\</span>
<span class="sd">            &amp;-\\sum_{i \\in {\\bf g}_1}</span>
<span class="sd">            \\sum_{\\substack{j \\in {\\bf g}_2 \\\\ q_jq_i &lt; 0}}</span>
<span class="sd">                \\frac{q_i q_j}{4 \\pi \\varepsilon_0 r_{\\rm c}} u_{\\rm elec}\\left(</span>
<span class="sd">                    \\frac{\\|{\\bf r}_i - {\\bf r}_j\\|}{r_{\\rm c}}</span>
<span class="sd">                \\right)</span>

<span class="sd">    where :math:`{\\bf g}_1` and :math:`{\\bf g}_2` are the two atom groups,</span>
<span class="sd">    :math:`r_{\\rm c}` is the cutoff distance, :math:`\\varepsilon_0` is the</span>
<span class="sd">    permittivity of empty space, and :math:`q_i` is the charge of atom :math:`i`. The</span>
<span class="sd">    Lennard-Jones parameters are given by the Lorentz-Berthelot mixing rule, i.e.</span>
<span class="sd">    :math:`\\epsilon_{ij} = \\sqrt{\\epsilon_i \\epsilon_j}`, and</span>
<span class="sd">    :math:`\\sigma_{ij} = (\\sigma_i + \\sigma_j)/2`.</span>

<span class="sd">    The function :math:`u_{\\rm disp}(x)` is a Lennard-Jones-like reduced potential with</span>
<span class="sd">    a highly softened repulsion part, defined as</span>

<span class="sd">    .. math::</span>

<span class="sd">        u_{\\rm disp}(x) = 4\\left(\\frac{1}{y^2} - \\frac{1}{y}\\right),</span>
<span class="sd">        \\quad \\text{where} \\quad</span>
<span class="sd">        y = |x^6 - 2| + 2</span>

<span class="sd">    The function :math:`u_{\\rm elec}(x)` provides a Coulomb-like decay with</span>
<span class="sd">    reaction-field screening, defined as</span>

<span class="sd">    .. math::</span>

<span class="sd">        u_{\\rm elec}(x) = \\frac{1}{x} + \\frac{x^2 - 3}{2}</span>

<span class="sd">    The screening considers a perfect conductor as the surrounding medium</span>
<span class="sd">    :cite:`Correa_2022`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Only attractive electrostatic interactions are considered (:math:`q_i q_i &lt; 0`).</span>
<span class="sd">        This makes :math:`S_{\\rm attr}({\\bf r})` exclusively non-negative. Its upper</span>
<span class="sd">        bound depends on the system and the chosen groups of atoms.</span>

<span class="sd">    The Lennard-Jones parameters, atomic charges, cutoff distance, boundary conditions,</span>
<span class="sd">    as well as whether to use a switching function and its corresponding switching</span>
<span class="sd">    distance, are taken from :openmm:`NonbondedForce` object. Any non-exclusion</span>
<span class="sd">    exceptions involving atoms in :math:`{\\bf g}_1` and :math:`{\\bf g}_2` are turned</span>
<span class="sd">    into exclusions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    group1</span>
<span class="sd">        The first atom group.</span>
<span class="sd">    group2</span>
<span class="sd">        The second atom group.</span>
<span class="sd">    nonbondedForce</span>
<span class="sd">        The :openmm:`NonbondedForce` object from which to collect the necessary</span>
<span class="sd">        parameters.</span>
<span class="sd">    reference</span>
<span class="sd">        A reference value (in energy units per mole) to which the collective variable</span>
<span class="sd">        should be normalized. If provided, the collective variable will become</span>
<span class="sd">        dimensionless.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from openmm import unit</span>
<span class="sd">    &gt;&gt;&gt; from openmmtools import testsystems</span>
<span class="sd">    &gt;&gt;&gt; model = testsystems.HostGuestExplicit()</span>
<span class="sd">    &gt;&gt;&gt; group1, group2 = [], []</span>
<span class="sd">    &gt;&gt;&gt; for residue in model.topology.residues():</span>
<span class="sd">    ...     if residue.name != &quot;HOH&quot;:</span>
<span class="sd">    ...         group = group1 if residue.name == &quot;B2&quot; else group2</span>
<span class="sd">    ...         group.extend(atom.index for atom in residue.atoms())</span>
<span class="sd">    &gt;&gt;&gt; forces = {f.getName(): f for f in model.system.getForces()}</span>
<span class="sd">    &gt;&gt;&gt; attraction_strength = AttractionStrength(</span>
<span class="sd">    ...     group1, group2, forces[&quot;NonbondedForce&quot;]</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; model.system.addForce(attraction_strength)</span>
<span class="sd">    5</span>
<span class="sd">    &gt;&gt;&gt; normalized_attraction_strength = AttractionStrength(</span>
<span class="sd">    ...     group1, group2, forces[&quot;NonbondedForce&quot;], 100*unit.kilojoules_per_mole,</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; model.system.addForce(normalized_attraction_strength)</span>
<span class="sd">    6</span>
<span class="sd">    &gt;&gt;&gt; platform = openmm.Platform.getPlatformByName(&quot;Reference&quot;)</span>
<span class="sd">    &gt;&gt;&gt; integrator = openmm.VerletIntegrator(1.0 * mmunit.femtoseconds)</span>
<span class="sd">    &gt;&gt;&gt; context = openmm.Context(model.system, integrator, platform)</span>
<span class="sd">    &gt;&gt;&gt; context.setPositions(model.positions)</span>
<span class="sd">    &gt;&gt;&gt; print(attraction_strength.getValue(context, 6))</span>
<span class="sd">    4912.514 kJ/mol</span>
<span class="sd">    &gt;&gt;&gt; print(attraction_strength.getEffectiveMass(context, 6))</span>
<span class="sd">    2.163946e-07 nm**2 mol**2 Da/(kJ**2)</span>
<span class="sd">    &gt;&gt;&gt; print(normalized_attraction_strength.getValue(context, 6))</span>
<span class="sd">    49.12514 dimensionless</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=too-many-arguments</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">group1</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">group2</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">nonbondedForce</span><span class="p">:</span> <span class="n">openmm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">,</span>
        <span class="n">reference</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">mmunit</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cutoff</span> <span class="o">=</span> <span class="n">mmunit</span><span class="o">.</span><span class="n">value_in_md_units</span><span class="p">(</span><span class="n">nonbondedForce</span><span class="o">.</span><span class="n">getCutoffDistance</span><span class="p">())</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mmunit</span><span class="o">.</span><span class="n">value_in_md_units</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">4</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ref</span><span class="si">}</span><span class="s2">*epsilon*(1/y - 1/y^2)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; + </span><span class="si">{</span><span class="n">ONE_4PI_EPS0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ref</span><span class="si">}</span><span class="s2">*q12sq*(1/x + (x^2 - 3)/2)&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;; x = r/</span><span class="si">{</span><span class="n">cutoff</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;; y = abs((r/sigma)^6 - 2) + 2&quot;</span>
            <span class="s2">&quot;; q12sq = max(0, -charge1*charge2)&quot;</span>
            <span class="s2">&quot;; epsilon = sqrt(epsilon1*epsilon2)&quot;</span>
            <span class="s2">&quot;; sigma = (sigma1 + sigma2)/2&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">nonbondedForce</span><span class="o">.</span><span class="n">usesPeriodicBoundaryConditions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;charge&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="s2">&quot;epsilon&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbondedForce</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">nonbondedForce</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">(</span><span class="n">atom</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="n">nonbondedForce</span><span class="o">.</span><span class="n">getUseSwitchingFunction</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">nonbondedForce</span><span class="o">.</span><span class="n">getSwitchingDistance</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addInteractionGroup</span><span class="p">(</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registerCV</span><span class="p">(</span>
            <span class="n">mmunit</span><span class="o">.</span><span class="n">kilojoules_per_mole</span> <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mmunit</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
            <span class="n">group1</span><span class="p">,</span>
            <span class="n">group2</span><span class="p">,</span>
            <span class="n">_NonbondedForce</span><span class="p">(</span><span class="n">nonbondedForce</span><span class="p">),</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mmunit</span><span class="o">.</span><span class="n">SerializableQuantity</span><span class="p">(</span><span class="n">reference</span><span class="p">),</span>
        <span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CVPack</a></h1>











<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serialization.html">Serialization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">Bibliography</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Redesign Science | CMS Cookiecutter v1.1.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>